<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OAuth Invite Function</title>
  <!-- Load the ArcGIS API for JavaScript -->
  <script src="https://js.arcgis.com/4.26/"></script>
  <script>
    // Use the ArcGIS API's AMD loader to bring in OAuth and IdentityManager modules.
    require(["esri/identity/OAuthInfo", "esri/identity/IdentityManager"], function(OAuthInfo, esriId) {
      
      // Use a flag to prevent the flow from executing multiple times.
      if (sessionStorage.getItem("invitationSent") === "true") {
        console.log("Invitation already sent. Exiting.");
        return;
      }
      
      // Configure OAuth information.
      // Replace the appId with your registered ArcGIS application's client ID.
      var info = new OAuthInfo({
        appId: "zqp645HsoVg1KwjM", 
        popup: true,
        portalUrl: "https://www.arcgis.com",
        // Use the current page URL (without any hash) as the redirect URI.
        redirectUri: window.location.href.split("#")[0]
      });
      esriId.registerOAuthInfos([info]);

      // Helper function: Extract query parameters from the URL.
      function getQueryParams() {
        var params = new URLSearchParams(window.location.search);
        return {
          firstname: params.get("firstname"),
          lastname: params.get("lastname"),
          email: params.get("email"),
          role: params.get("role"),
          userLicenseTypeId: params.get("userLicenseTypeId")
        };
      }

      // Helper function: Extract an OAuth token from the URL hash, if present.
      function getTokenFromHash() {
        if (window.location.hash && window.location.hash.indexOf("access_token") !== -1) {
          var hash = window.location.hash.substr(1); // remove the leading '#'
          var params = new URLSearchParams(hash);
          return params.get("access_token");
        }
        return null;
      }

      // Function to send the invitation using the provided token.
      function sendInvitation(token) {
        var inviteUrl = "https://cap-gis.maps.arcgis.com/sharing/rest/portals/self/invite";
        var userParams = getQueryParams();

        // Build the invitation payload using the passed query parameters.
        var invitation = {
          invitations: [{
            firstname: userParams.firstname || "DefaultFirstName",
            lastname: userParams.lastname || "DefaultLastName",
            email: userParams.email || "default@example.com",
            role: userParams.role || "org_user",
            userLicenseTypeId: userParams.userLicenseTypeId || "",
            provider: "arcgis",
            userType: "namedUser"
          }]
        };

        // Build URL-encoded parameters.
        var params = new URLSearchParams();
        params.append("invitationList", JSON.stringify(invitation));
        params.append("message", "Welcome to the organization!");
        params.append("f", "json");
        params.append("token", token);

        // Send the invitation using a POST request.
        fetch(inviteUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString()
        })
        .then(function(response) { 
          return response.json();
        })
        .then(function(data) {
          console.log("Invitation response:", data);
          alert("Invitation sent successfully!");
          // Set the flag so the invitation flow does not re-run.
          sessionStorage.setItem("invitationSent", "true");
          // Attempt to close the window if it was opened as a popup.
          if (window.opener) {
            window.close();
          } else {
            // Otherwise, redirect to a 'thank you' or confirmation page.
            window.location.href = "thankyou.html";
          }
        })
        .catch(function(err) {
          console.error("Error sending invitation:", err);
          alert("Error sending invitation: " + err);
        });
      }

      // Main function: Initiates the OAuth flow and sends the invitation.
      function init() {
        var token = getTokenFromHash();
        if (token) {
          // Remove the hash from the URL for neatness.
          history.replaceState(null, "", window.location.pathname + window.location.search);
          sendInvitation(token);
        } else {
          // Trigger OAuth sign-in.
          esriId.getCredential(info.portalUrl + "/sharing/rest")
          .then(function(credential) {
            sendInvitation(credential.token);
          })
          .catch(function(err) {
            console.error("Error retrieving credential:", err);
            alert("Error retrieving credential: " + err);
          });
        }
      }

      // Start the process when the page loads.
      window.onload = init;
    });
  </script>
</head>
<body>
  <h1>Processing OAuth & Invitation...</h1>
  <p>Please wait while we authenticate and send the invitation.</p>
</body>
</html>
