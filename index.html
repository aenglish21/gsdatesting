<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OAuth Invite Function</title>
  <!-- Load the ArcGIS API for JavaScript -->
  <script src="https://js.arcgis.com/4.26/"></script>
  <script>
    require(["esri/identity/OAuthInfo", "esri/identity/IdentityManager"], function(OAuthInfo, esriId) {

      // Prevent duplicate execution (if needed)
      if (sessionStorage.getItem("invitationSent") === "true") {
        console.log("Invitation already sent. Exiting.");
        return;
      }
      
      // Configure OAuth information.
      var info = new OAuthInfo({
        appId: "NdDfitFYbAyF6ETt",  // Replace with your ArcGIS app ID
        popup: true,
        portalUrl: "https://www.arcgis.com",
        // Use the current page URL (without hash) as the redirect URI.
        redirectUri: window.location.href.split("#")[0]
      });
      esriId.registerOAuthInfos([info]);

      // Helper function: Get query parameters from the URL.
      function getQueryParams() {
        var params = new URLSearchParams(window.location.search);
        return {
          firstname: params.get("firstname"),
          lastname: params.get("lastname"),
          email: params.get("email"),
          role: params.get("role"),
          userLicenseTypeId: params.get("userLicenseTypeId")
        };
      }

      // Helper function: Extract token from the URL hash, if present.
      function getTokenFromHash() {
        if (window.location.hash && window.location.hash.indexOf("access_token") !== -1) {
          var hash = window.location.hash.substr(1); // Remove the leading '#'
          var params = new URLSearchParams(hash);
          return params.get("access_token");
        }
        return null;
      }

      // Function to send the invitation.
      function sendInvitation(token) {
        var inviteUrl = "https://cap-gis.maps.arcgis.com/sharing/rest/portals/self/invite";
        var userParams = getQueryParams();

        // Build the invitation payload.
        var invitation = {
          invitations: [{
            firstname: userParams.firstname || "DefaultFirstName",
            lastname: userParams.lastname || "DefaultLastName",
            email: userParams.email || "default@example.com",
            role: userParams.role || "org_user",
            userLicenseTypeId: userParams.userLicenseTypeId || "",
            provider: "arcgis",
            userType: "namedUser"
          }]
        };

        console.log("Invitation payload:", invitation);

        // Build URL-encoded parameters.
        var params = new URLSearchParams();
        params.append("invitationList", JSON.stringify(invitation));
        params.append("message", "Welcome to the organization!");
        params.append("f", "json");
        params.append("token", token);

        console.log("Sending invitation to:", inviteUrl);
        console.log("POST body:", params.toString());

        // Send the POST request.
        fetch(inviteUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString()
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          console.log("Invitation response:", data);
          if (data.success === true) {
            alert("Invitation sent successfully!");
            sessionStorage.setItem("invitationSent", "true");
            // If opened as a popup, close the window:
            if (window.opener) {
              window.close();
            } else {
              // Otherwise, redirect to a confirmation page (if available)
              window.location.href = "thankyou.html";
            }
          } else {
            // If success is not true, output the returned error details.
            alert("Invitation failed: " + JSON.stringify(data));
          }
        })
        .catch(function(err) {
          console.error("Error sending invitation:", err);
          alert("Error sending invitation: " + err);
        });
      }

      // Main function: Initiate OAuth and send invitation.
      function init() {
        var token = getTokenFromHash();
        if (token) {
          // Remove the token hash from the URL.
          history.replaceState(null, "", window.location.pathname + window.location.search);
          sendInvitation(token);
        } else {
          // If no token, trigger the OAuth sign-in flow.
          esriId.getCredential(info.portalUrl + "/sharing/rest")
          .then(function(credential) {
            sendInvitation(credential.token);
          })
          .catch(function(err) {
            console.error("Error retrieving credential:", err);
            alert("Error retrieving credential: " + err);
          });
        }
      }

      window.onload = init;
    });
  </script>
</head>
<body>
  <h1>Processing OAuth & Invitation...</h1>
  <p>Please wait while we authenticate and send the invitation.</p>
</body>
</html>
